<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Онлайн-статистика — Время Чудес</title>
  <style>
    :root{
      --bg:#f7f4ff; --card:#fff; --accent:#7a5cff; --accent-2:#ff7ac6; --ink:#2b2b2b; --muted:#6b6b6b; --ring:0 8px 40px rgba(122,92,255,.15)
    }
    html,body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #ffe8f6 0, transparent 60%), radial-gradient(1000px 800px at 110% 10%, #e7e2ff 0, transparent 60%), var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;}
    .wrap{max-width:1000px;margin:36px auto;padding:16px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{margin:0;font-size:26px}
    select{padding:10px 12px;border-radius:12px;border:1px solid #e6e0ff;outline:none}
    .grid{display:grid;gap:14px}
    @media (min-width:760px){ .grid{grid-template-columns:repeat(4,1fr);} }
    .card{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:16px 18px;position:relative;overflow:hidden}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
    .num{font-size:28px;font-weight:800;margin-top:6px}
    .row{display:grid;gap:14px;margin-top:16px}
    .note{font-size:12px;color:var(--muted);margin-top:12px}
    .badge{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .city{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="city">
        <h1>Статистика</h1>
        <span class="badge" id="cityBadge">Город: —</span>
      </div>
      <div>
        <label style="font-size:13px;color:#4f4a6b;margin-right:8px">Город</label>
        <select id="citySel"></select>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div class="label">Всего детей</div><div class="num" id="c_total">0</div></div>
      <div class="card"><div class="label">Уникальных адресов</div><div class="num" id="c_addr">0</div></div>
      <div class="card"><div class="label">Обычные подарки</div><div class="num" id="c_usual">0</div></div>
      <div class="card"><div class="label">Необычные подарки</div><div class="num" id="c_unusual">0</div></div>
    </div>

    <div class="row">
      <div class="card">
        <div class="label">Итого по всем городам</div>
        <div class="num" id="g_total">0</div>
        <div class="note">Адресов: <span id="g_addr">0</span> • Обычных: <span id="g_usual">0</span> • Необычных: <span id="g_unusual">0</span></div>
      </div>
    </div>

    <div class="note">Страница скрытая, для организаторов. Обновляется при открытии (данные берутся из Google Таблицы).</div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec?action=stats';

    async function loadStats(){
      const res = await fetch(API, {cache:'no-store'});
      const data = await res.json();
      render(data);
    }

    function render(data){
      const citySel = document.getElementById('citySel');
      const cities = data.cities.length ? data.cities : ['—'];
      citySel.innerHTML = cities.map(c=>`<option>${c}</option>`).join('');
      const first = cities[0];
      citySel.value = first;
      showCity(first, data);
      // итого
      setText('g_total', data.totals.children);
      setText('g_addr', data.totals.addresses);
      setText('g_usual', data.totals.usual);
      setText('g_unusual', data.totals.unusual);
      citySel.addEventListener('change', ()=> showCity(citySel.value, data));
    }

    function showCity(city, data){
      document.getElementById('cityBadge').textContent = 'Город: ' + city;
      const c = data.byCity[city] || {children:0, addresses:0, usual:0, unusual:0};
      setText('c_total', c.children);
      setText('c_addr', c.addresses);
      setText('c_usual', c.usual);
      setText('c_unusual', c.unusual);
    }

    function setText(id,val){ document.getElementById(id).textContent = String(val); }

    loadStats();
  </script>
</body>
</html>
