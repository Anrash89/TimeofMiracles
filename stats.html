<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Онлайн-статистика — Время Чудес</title>
  <style>
    :root{
      --bg:#f7f4ff; --card:#fff; --accent:#7a5cff; --accent-2:#ff7ac6; --ink:#2b2b2b; --muted:#6b6b6b; --ring:0 8px 40px rgba(122,92,255,.15)
    }
    html,body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #ffe8f6 0, transparent 60%), radial-gradient(1000px 800px at 110% 10%, #e7e2ff 0, transparent 60%), var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;}
    .wrap{max-width:1000px;margin:36px auto;padding:16px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{margin:0;font-size:26px}
    select{padding:10px 12px;border-radius:12px;border:1px solid #e6e0ff;outline:none}
    .grid{display:grid;gap:14px}
    @media (min-width:760px){ .grid{grid-template-columns:repeat(4,1fr);} }
    .card{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:16px 18px;position:relative;overflow:hidden}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
    .num{font-size:28px;font-weight:800;margin-top:6px}
    .row{display:grid;gap:14px;margin-top:16px}
    .note{font-size:12px;color:var(--muted);margin-top:12px}
    .badge{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .city{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="city">
        <h1>Статистика</h1>
        <span class="badge" id="cityBadge">Город: —</span>
      </div>
      <div>
        <label style="font-size:13px;color:#4f4a6b;margin-right:8px">Город</label>
        <select id="citySel"></select>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div class="label">Всего детей</div><div class="num" id="c_total">0</div></div>
      <div class="card"><div class="label">Уникальных адресов</div><div class="num" id="c_addr">0</div></div>
      <div class="card"><div class="label">Обычные подарки</div><div class="num" id="c_usual">0</div></div>
      <div class="card"><div class="label">Необычные подарки</div><div class="num" id="c_unusual">0</div></div>
    </div>

    <div class="row">
      <div class="card">
        <div class="label">Итого по всем городам</div>
        <div class="num" id="g_total">0</div>
        <div class="note">Адресов: <span id="g_addr">0</span> • Обычных: <span id="g_usual">0</span> • Необычных: <span id="g_unusual">0</span></div>
      </div>
    </div>

    <div class="note">Страница скрытая, для организаторов. Обновляется при открытии (данные берутся из Google Таблицы).</div>
  </div>

  <script>
    // Запрашиваем с флагом rows=1 — если сервер поддерживает, вернёт сырые строки
    const API = 'https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec?action=stats&rows=1';

    async function loadStats(){
      const res = await fetch(API, {cache:'no-store'});
      const data = await res.json();
      // Если сервер прислал rows — пересчитаем всё без дублей
      const view = Array.isArray(data.rows) ? recomputeFromRows(data.rows) : data;
      render(view);
    }

    // ====== Пересчёт без дублей на клиенте (если пришли сырые строки) ======
    function recomputeFromRows(rows){
      // Нормализуем имена полей => набор объектов с одинаковыми ключами
      const norm = rows.map(r => normalizeRow(r));

      // Удаляем дубли: оставляем первую запись с одним и тем же ключом семьи
      const uniqMap = new Map();
      norm.forEach(r=>{
        const key = [r.City, r.District, r.Street, r.Apartment, r.Parent_Name, r.Phone].join('|').toLowerCase();
        if (!uniqMap.has(key)) uniqMap.set(key, r);
      });
      const uniq = Array.from(uniqMap.values());

      // Считаем по городам
      const byCity = {};
      const addrAll = new Set();
      uniq.forEach(r=>{
        const city = r.City || '—';
        const addrKey = [r.City, r.District, r.Street, r.Apartment].join('|').toLowerCase();
        addrAll.add(addrKey);

        const gifts = giftsForRow(r);
        if (!byCity[city]) byCity[city] = { children:0, addressesSet:new Set(), usual:0, unusual:0, gifts:0 };
        byCity[city].children += gifts.count; // дети = подарки
        byCity[city].addressesSet.add(addrKey);
        byCity[city].usual   += gifts.usual;
        byCity[city].unusual += gifts.unusual;
        byCity[city].gifts   += gifts.count;
      });

      const cities = Object.keys(byCity).sort();
      const byCityOut = {};
      let totalChildren=0,totalUsual=0,totalUnusual=0,totalGifts=0;
      cities.forEach(c=>{
        byCityOut[c] = {
          children: byCity[c].children,
          addresses: byCity[c].addressesSet.size,
          usual: byCity[c].usual,
          unusual: byCity[c].unusual,
          gifts: byCity[c].gifts
        };
        totalChildren += byCity[c].children;
        totalUsual    += byCity[c].usual;
        totalUnusual  += byCity[c].unusual;
        totalGifts    += byCity[c].gifts;
      });

      return {
        cities,
        byCity: byCityOut,
        totals: {
          children: totalChildren,
          addresses: addrAll.size,
          usual: totalUsual,
          unusual: totalUnusual,
          gifts: totalGifts
        }
      };
    }

    // Подсчёт подарков/необычных для строки (как на сервере)
    function giftsForRow(r){
      const mainUnusual = isMainGiftUnusual(r.Food_Restrictions, r.Food_Notes) ? 1 : 0;
      const sibs = siblingItems(r); // массив {raw, unusual}
      const count = 1 + sibs.length;
      const unusual = mainUnusual + sibs.filter(s=>s.unusual).length;
      const usual = Math.max(count - unusual, 0);
      return {count, unusual, usual};
    }

    function isMainGiftUnusual(foodRaw, notesRaw){
      const food = (foodRaw || '').toString().trim().toLowerCase();
      const notes = (notesRaw || '').toString().trim().toLowerCase();
      if (!food && !notes) return false;
      if (food === 'нет пищевых ограничений') return !!notes;
      if (food.includes('паллиатив')) return true;
      if (food && food !== 'нет пищевых ограничений') return true;
      return !!notes;
    }

    function siblingItems(r){
      // поддержка Siblings_Text / Siblings_JSON (JSON или обычный текст)
      const t = (r.Siblings_Text || '').toString();
      const j = (r.Siblings_JSON || '').toString();

      if (t.trim()) return parseSiblingText(t);
      if (j.trim()){
        try{
          const arr = JSON.parse(j);
          if (Array.isArray(arr)) {
            return arr.map(o=>{
              const raw = [safe(o.name_age||o.name||''), safe(o.equivalent?`соответствует ${o.equivalent}`:''), safe(o.food||'')].filter(Boolean).join(', ');
              const l = raw.toLowerCase();
              const has = /глют|целиак|лакт|аллерг|паллиатив|огранич/.test(l);
              const no  = /\bнет\b|\bбез огранич/.test(l);
              return {raw, unusual: has && !no ? true : (!has && no ? false : has)};
            }).filter(x=>x.raw);
          }
        }catch(_){}
        // если внутри Siblings_JSON лежит не JSON, а текст — тоже разберём
        return parseSiblingText(j);
      }
      return [];
    }

    function parseSiblingText(raw){
      const normalized = raw
        .replace(/•/g, '\n')
        .replace(/\s[–—-]\s/g, '\n')
        .replace(/[|/]+/g, '\n')
        .replace(/;\s*/g, '\n')
        .replace(/\r?\n+/g, '\n');

      return normalized.split('\n').map(s=>s.trim()).filter(Boolean).map(line=>{
        const l = line.toLowerCase();
        const has = /глют|целиак|лакт|аллерг|паллиатив|огранич/.test(l);
        const no  = /\bнет\b|\bбез огранич/.test(l);
        return {raw: line, unusual: has && !no ? true : (!has && no ? false : has)};
      });
    }

    function normalizeRow(r){
      // если пришла строка массивом — сопоставим по заголовкам
      if (Array.isArray(r)) return {};
      // нормализуем ключи (на всякий случай)
      const out = {};
      Object.keys(r).forEach(k=>{
        out[stdKey(k)] = r[k];
      });
      return out;
    }
    function stdKey(k){
      return String(k).trim()
        .replace(/\s+/g,'_')
        .replace(/[^\w]/g,'_');
    }
    function safe(v){ return (v==null) ? '' : String(v).trim(); }

    // ====== Рендер ======
    function render(data){
      const citySel = document.getElementById('citySel');
      const cities = data.cities.length ? data.cities : ['—'];
      citySel.innerHTML = cities.map(c=>`<option>${c}</option>`).join('');
      const first = cities[0];
      citySel.value = first;
      showCity(first, data);
      // итого
      setText('g_total', data.totals.children);
      setText('g_addr', data.totals.addresses);
      setText('g_usual', data.totals.usual);
      setText('g_unusual', data.totals.unusual);
      citySel.addEventListener('change', ()=> showCity(citySel.value, data));
    }

    function showCity(city, data){
      document.getElementById('cityBadge').textContent = 'Город: ' + city;
      const c = data.byCity[city] || {children:0, addresses:0, usual:0, unusual:0};
      setText('c_total', c.children);
      setText('c_addr', c.addresses);
      setText('c_usual', c.usual);
      setText('c_unusual', c.unusual);
    }

    function setText(id,val){ document.getElementById(id).textContent = String(val); }

    loadStats();
  </script>
</body>
</html>
