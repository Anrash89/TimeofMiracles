<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Заявка для ребёнка — Время Чудес</title>
  <style>
    :root{
      --bg:#f7f4ff; --card:#ffffff; --accent:#7a5cff; --accent-2:#ff7ac6;
      --ink:#2b2b2b; --muted:#6b6b6b; --ok:#27ae60; --err:#e74c3c;
      --ring: 0 8px 40px rgba(122,92,255,.15);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:
        radial-gradient(1200px 600px at 10% -10%, #ffe8f6 0, transparent 60%),
        radial-gradient(1000px 800px at 110% 10%, #e7e2ff 0, transparent 60%),
        var(--bg);
      color:var(--ink);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }
    .wrap{max-width:900px;margin:40px auto;padding:16px}
    .card{background:var(--card);border-radius:20px;box-shadow:var(--ring);padding:24px 22px;position:relative;overflow:hidden}
    .halo{position:absolute; inset:-60px -80px auto auto; width:260px; height:260px; background: conic-gradient(from 0deg, #ffd2ef, #d6c8ff, #ffd2ef); filter: blur(40px) saturate(120%); opacity:.25; border-radius:50%; pointer-events:none;}
    .hearts{position:absolute; left:-40px; bottom:-20px; width:220px; height:220px; opacity:.15; pointer-events:none; background:
      radial-gradient(circle at 40% 40%, #ff73b2 0 12%, transparent 13%),
      radial-gradient(circle at 70% 40%, #ff73b2 0 12%, transparent 13%),
      radial-gradient(circle at 55% 60%, #ff73b2 0 16%, transparent 17%); filter: blur(2px); transform: rotate(-18deg);}
    h1{margin:0 0 6px; font-size:28px; letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    h1 .badge{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px;}
    p.lead{margin:0 0 20px;color:var(--muted)}
    .grid{display:grid; gap:14px}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr;} .grid-3{grid-template-columns:1fr 1fr 1fr;} }
    label{font-weight:600; font-size:14px; margin-bottom:6px; display:block}
    input[type="text"], input[type="tel"], input[type="number"], select, textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6e0ff; outline:none; background:#fff; transition:.2s border-color,.2s box-shadow;
    }
    textarea{min-height:96px; resize:vertical}
    input:focus,select:focus,textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(122,92,255,.12)}
    .row{display:grid; gap:10px}
    .btn{appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700;}
    .btn.primary{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 8px 24px rgba(255,122,198,.18);}
    .btn.secondary{ background:#f4f1ff; color:#5a4ae6;}
    .status{margin-top:14px; font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .footnote{font-size:12px; color:#6b6b6b}
    .divider{height:1px;background:#efeaff;margin:10px 0 4px}
    .required{color:#d33;margin-left:4px}
    .consent{display:flex; gap:10px; align-items:flex-start; margin-top:4px}
    .mini{font-size:12px;color:#6b6b6b}
    .siblings{display:grid; gap:12px}
    .sib{border:1px solid #efeaff; border-radius:14px; padding:12px; background:#fff}
    .sib h4{margin:0 0 8px; font-size:14px}
    .hint{display:none!important} input::placeholder,textarea::placeholder{color:transparent!important}
    .center{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .muted{color:#6b6b6b;font-size:14px}
    .hidden{display:none!important}
    .notice{background:#fff7f7;border:1px solid #ffdede;color:#9b2c2c;padding:12px 14px;border-radius:12px;font-size:14px}
    .good{background:#f4fff6;border:1px solid #dff5e4;color:#1f7a3a;padding:12px 14px;border-radius:12px;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="halo"></div>
      <div class="hearts"></div>
      <h1>Заявка для ребёнка <span class="badge">благотворительность</span></h1>
      <p class="lead">Пожалуйста, сначала выберите город — мы проверим, открыт ли набор в нём ❤️</p>

      <!-- ШАГ 0 -->
      <div id="cityStep">
        <div class="center" style="margin:6px 0 10px">
          <label for="cityChooser" style="font-weight:700">Город</label>
          <select id="cityChooser" style="min-width:260px"></select>
          <button id="goBtn" class="btn primary">Продолжить</button>
        </div>
        <div id="cityNote" class="muted"></div>
        <div id="cityLock" class="notice hidden" style="margin-top:10px">
          К сожалению, набор заявок по детям в этом городе уже завершён
        </div>
        <div id="cityOk" class="good hidden" style="margin-top:10px">
          Набор в этом городе открыт. Можно заполнить форму ниже.
        </div>
        <div class="divider"></div>
      </div>

      <!-- скрытый iframe -->
      <iframe name="hidden_iframe" style="display:none;"></iframe>

      <!-- ШАГ 1 — форма -->
      <form id="wishForm" class="hidden" action="https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec" method="POST" target="hidden_iframe">
        <input type="hidden" name="siblings_text" id="siblings_text" value=""/>

        <div class="grid grid-2">
          <div class="row">
            <label>Имя и фамилия ребёнка <span class="required">*</span></label>
            <input type="text" name="child_name" required />
          </div>
          <div class="row">
            <label>Возраст (полных лет) <span class="required">*</span></label>
            <input type="number" name="child_age" min="0" step="0.1" required />
          </div>
        </div>

        <div class="grid grid-2">
          <div class="row">
            <label>Соответствует развитию (лет) <span class="required">*</span></label>
            <input type="number" name="child_equivalent_age" min="0" step="0.1" required />
          </div>
          <div class="row">
            <label>Пищевые ограничения <span class="required">*</span></label>
            <select name="food_restrictions" id="food_select" required>
              <option value="" selected disabled>Выберите</option>
              <option>Нет пищевых ограничений</option>
              <option>Не переносит глютен</option>
              <option>Непереносимость лактозы</option>
              <option>Аллергии (указать ниже)</option>
              <option>Другое (указать ниже)</option>
              <option>Паллиатив</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label>Пояснение по ограничениям (если есть)</label>
          <textarea name="food_notes"></textarea>
        </div>

        <div class="divider"></div>

        <h3 style="margin:10px 0 6px">Другие дети в семье</h3>
        <div class="mini">Добавляйте карточки для каждого ребёнка.</div>

        <div class="siblings" id="siblings"></div>
        <div class="row">
          <button type="button" class="btn secondary" id="addSib">+ Добавить ребёнка</button>
        </div>

        <div class="divider"></div>

        <h3 style="margin:10px 0 6px">Контакты и адрес</h3>
        <div class="grid grid-3">
          <div class="row">
            <label>Город <span class="required">*</span></label>
            <input type="text" name="city" id="cityField" required readonly />
          </div>
          <div class="row">
            <label>Район <span class="required">*</span></label>
            <input type="text" name="district" required />
          </div>
          <div class="row">
            <label>Улица и дом <span class="required">*</span></label>
            <input type="text" name="street" required />
          </div>
        </div>

        <div class="grid grid-3">
          <div class="row">
            <label>Квартира</label>
            <input type="text" name="apartment" />
          </div>
          <div class="row">
            <label>Имя мамы (опекуна) <span class="required">*</span></label>
            <input type="text" name="parent_name" required />
          </div>
          <div class="row">
            <label>Телефон <span class="required">*</span></label>
            <input type="tel" name="phone" id="phone" required />
            <div class="hint">Принимаются: +7XXXXXXXXXX, 8XXXXXXXXXX, 9XXXXXXXXX</div>
          </div>
        </div>

        <div class="consent">
          <input type="checkbox" id="consent" required />
          <label for="consent" class="footnote">
            Я согласен(на) на обработку персональных данных для целей благотворительной помощи. <span class="required">*</span>
          </label>
        </div>

        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button type="submit" class="btn primary">Отправить заявку</button>
          <button type="reset" class="btn secondary" id="resetBtn">Очистить</button>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    // === Конфиг ===
    const API_STATS = 'https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec?action=stats';
    const CITY_LIMIT = 500; // лимит по ДЕТЯМ
    const CITIES = [
      "Новосибирск","Томск","Красноярск","Обь","Искитим","Бердск","Челябинск","Екатеринбург","Тюмень",
      "Новомосковск","Владимир","Пашино","Гвардейский","Камень-на-Оби","ДНР","Гатчина","Краснообск",
      "Тогучин","Сокур","Куйбышев","Колывань","Верх Тула","Самара","Норильск","Черепаново","Вороново",
      "Кольцово","Казанка","Кинель (Алексеевка, Самарская обл.)","Кудряшовский","Большая Черниговка"
    ];

    // Элементы шага выбора города
    const cityChooser = document.getElementById('cityChooser');
    const cityNote  = document.getElementById('cityNote');
    const cityLock  = document.getElementById('cityLock');
    const cityOk    = document.getElementById('cityOk');
    const goBtn     = document.getElementById('goBtn');
    const form      = document.getElementById('wishForm');
    const cityField = document.getElementById('cityField');

    // Наполняем список городов
    cityChooser.innerHTML = CITIES.map(c=>`<option value="${c}">${c}</option>`).join('');
    cityChooser.value = "Новосибирск";

    let statsCache = null;
    async function ensureStats(){
      if (statsCache) return statsCache;
      try{
        const r = await fetch(API_STATS, {cache:'no-store'});
        statsCache = await r.json();
      }catch(_){
        statsCache = {byCity:{}};
      }
      return statsCache;
    }

    async function checkCity(){
      cityLock.classList.add('hidden');
      cityOk.classList.add('hidden');
      goBtn.disabled = true;
      cityNote.textContent = 'Считаем, сколько детей уже записались...';
      const data = await ensureStats();
      const city = cityChooser.value;
      const rec = data.byCity && data.byCity[city] ? data.byCity[city] : {children:0};
      const takenChildren = Number(rec.children || 0); // <<< считаем ДЕТЕЙ
      if (takenChildren >= CITY_LIMIT){
        cityNote.textContent = '';
        cityLock.classList.remove('hidden');
        goBtn.disabled = true;
      }else{
        cityNote.textContent = '';
        cityOk.classList.remove('hidden');
        goBtn.disabled = false;
      }
    }

    cityChooser.addEventListener('change', checkCity);
    checkCity();

    goBtn.addEventListener('click', ()=>{
      form.classList.remove('hidden');
      cityField.value = cityChooser.value;
      cityField.readOnly = true;
      form.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // === Динамические "Другие дети" ===
    const statusEl = document.getElementById('status');
    const siblingsWrap = document.getElementById('siblings');
    const addBtn = document.getElementById('addSib');
    const sibField = document.getElementById('siblings_text');

    function sibTemplate(i){
      const el = document.createElement('div');
      el.className = 'sib';
      el.innerHTML = `
        <h4>Ребёнок в семье #${i}</h4>
        <div class="grid grid-2">
          <div class="row">
            <label>Имя</label>
            <input type="text" data-sib="name" />
          </div>
          <div class="row">
            <label>Возраст</label>
            <input type="text" data-sib="age" />
          </div>
        </div>
        <div class="grid grid-2">
          <div class="row">
            <label>Соответствует развитию (лет)</label>
            <input type="number" min="0" step="0.1" data-sib="equivalent" />
          </div>
          <div class="row">
            <label>Пищевые ограничения</label>
            <select data-sib="food">
              <option value="" selected disabled>Выберите</option>
              <option>Нет пищевых ограничений</option>
              <option>Не переносит глютен</option>
              <option>Непереносимость лактозы</option>
              <option>Аллергии (указать ниже)</option>
              <option>Другое (указать ниже)</option>
              <option>Паллиатив</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button type="button" class="btn secondary" data-action="remove">Удалить</button>
        </div>
      `;
      return el;
    }

    function renumberSiblings(){
      document.querySelectorAll('.sib h4').forEach((h,idx)=>h.textContent=`Ребёнок в семье #${idx+1}`);
    }

    function serializeSiblingsToText(){
      const lines = [];
      document.querySelectorAll('.sib').forEach(box=>{
        const name = (box.querySelector('[data-sib="name"]').value||'').trim();
        const age  = (box.querySelector('[data-sib="age"]').value||'').trim();
        const eq   = (box.querySelector('[data-sib="equivalent"]').value||'').trim();
        const foodSel = box.querySelector('[data-sib="food"]');
        const food = foodSel ? (foodSel.value || '').trim() : '';
        if (name || age || eq || food){
          const parts = [];
          if (name) parts.push(name);
          if (age) parts.push(age);
          if (eq)  parts.push(`соответствует ${eq}`);
          if (food) parts.push(food);
          lines.push(parts.join(', '));
        }
      });
      sibField.value = lines.join('\n');
    }

    addBtn.addEventListener('click', ()=>{
      const i = document.querySelectorAll('.sib').length + 1;
      siblingsWrap.appendChild(sibTemplate(i));
    });

    siblingsWrap.addEventListener('click', (e)=>{
      if(e.target.matches('[data-action="remove"]')){
        e.target.closest('.sib').remove();
        renumberSiblings();
        serializeSiblingsToText();
      }
    });
    siblingsWrap.addEventListener('input', serializeSiblingsToText);
    siblingsWrap.addEventListener('change', serializeSiblingsToText);

    // === Телефон → +7XXXXXXXXXX ===
    function normalizePhone(raw){
      const digits = (raw.match(/\d/g) || []).join('');
      if (digits.length === 11 && digits[0] === '8') return '+7' + digits.slice(1);
      if (digits.length === 11 && digits[0] === '7') return '+7' + digits.slice(1);
      if (digits.length === 10 && digits[0] === '9') return '+7' + digits;
      const compact = raw.replace(/\s|\-|\(|\)/g,'');
      if (compact.startsWith('+7') && digits.length === 11 && digits[0] === '7') return '+7' + digits.slice(1);
      return null;
    }

    // === Отправка через iframe ===
    let submitted = false;
    const iframe = document.querySelector('iframe[name="hidden_iframe"]');
    iframe.addEventListener('load', ()=>{
      if (!submitted) return;
      statusEl.innerHTML = '<span class="ok">Спасибо! Заявка отправлена. Мы свяжемся с вами.</span>';
      form.reset();
      cityField.value = cityChooser.value;
      siblingsWrap.innerHTML = '';
      sibField.value = '';
      submitted = false;
      window.scrollTo({top:0, behavior:'smooth'});
    });

    form.addEventListener('submit', (e)=>{
      serializeSiblingsToText();
      const phoneInput = document.getElementById('phone');
      const norm = normalizePhone(phoneInput.value);
      if(!norm){
        e.preventDefault();
        statusEl.innerHTML = '<span class="err">Проверьте телефон. Пример: +7 913 913-33-33 или 8 913 913 33 33 или 9139133333.</span>';
        phoneInput.focus();
        return;
      }
      phoneInput.value = norm;
      cityField.value = cityChooser.value;
      submitted = true;
      statusEl.textContent = 'Отправляем...';
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      setTimeout(()=>{ cityField.value = cityChooser.value; }, 0);
    });
  </script>
</body>
</html>

