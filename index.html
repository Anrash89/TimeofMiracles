<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ó–∞—è–≤–∫–∞ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ ‚Äî –í—Ä–µ–º—è –ß—É–¥–µ—Å</title>
  <style>
    :root{
      --bg:#f7f4ff;
      --card:#ffffff;
      --accent:#7a5cff;
      --accent-2:#ff7ac6;
      --ink:#2b2b2b;
      --muted:#6b6b6b;
      --ok:#27ae60;
      --err:#e74c3c;
      --ring: 0 8px 40px rgba(122,92,255,.15);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:radial-gradient(1200px 600px at 10% -10%, #ffe8f6 0, transparent 60%),
                 radial-gradient(1000px 800px at 110% 10%, #e7e2ff 0, transparent 60%),
                 var(--bg);
      color:var(--ink);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }
    .wrap{max-width:900px;margin:40px auto;padding:16px}
    .card{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--ring);
      padding:24px 22px;
      position:relative;overflow:hidden;
    }
    .halo{
      position:absolute; inset:-60px -80px auto auto; width:260px; height:260px;
      background: conic-gradient(from 0deg, #ffd2ef, #d6c8ff, #ffd2ef);
      filter: blur(40px) saturate(120%); opacity:.25; border-radius:50%; pointer-events:none;
    }
    .hearts{
      position:absolute; left:-40px; bottom:-20px; width:220px; height:220px; opacity:.15; pointer-events:none;
      background:
        radial-gradient(circle at 40% 40%, #ff73b2 0 12%, transparent 13%),
        radial-gradient(circle at 70% 40%, #ff73b2 0 12%, transparent 13%),
        radial-gradient(circle at 55% 60%, #ff73b2 0 16%, transparent 17%);
      filter: blur(2px); transform: rotate(-18deg);
    }
    h1{ margin:0 0 6px; font-size:28px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    h1 .badge{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; }
    p.lead{margin:0 0 20px;color:var(--muted)}
    .grid{display:grid; gap:14px}
    @media (min-width:720px){
      .grid-2{ grid-template-columns:1fr 1fr; }
      .grid-3{ grid-template-columns:1fr 1fr 1fr; }
    }
    label{font-weight:600; font-size:14px; margin-bottom:6px; display:block}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    input[type="text"], input[type="tel"], input[type="number"], select, textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6e0ff; outline:none; background:#fff;
      transition:.2s border-color, .2s box-shadow;
    }
    textarea{min-height:96px; resize:vertical}
    input:focus, select:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(122,92,255,.12)}
    .row{display:grid; gap:10px}

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn{appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700; }
    .btn.primary{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 8px 24px rgba(255,122,198,.18); }
    .btn.secondary{ background:#f4f1ff; color:#5a4ae6; box-shadow:none; }

    .status{margin-top:14px; font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .footnote{font-size:12px; color:#6b6b6b}
    .divider{height:1px;background:#efeaff;margin:10px 0 4px}
    .required{color:#d33;margin-left:4px}
    .consent{display:flex; gap:10px; align-items:flex-start; margin-top:4px}
    .consent input{margin-top:3px}
    .mini{font-size:12px;color:#6b6b6b}

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±—Ä–∞—Ç—å–µ–≤/—Å–µ—Å—Ç—ë—Ä */
    .siblings{display:grid; gap:12px}
    .sib{ border:1px solid #efeaff; border-radius:14px; padding:12px; background:#fff; }
    .sib h4{margin:0 0 8px; font-size:14px}

    /* –°–ø—Ä—è—Ç–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã */
    .hint{ display:none !important; }
    input::placeholder, textarea::placeholder{ color:transparent !important; }

    /* –®–∞–≥ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ */
    .center{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .muted{color:#6b6b6b;font-size:14px}
    .hidden{display:none !important}
    .notice{background:#fff7f7;border:1px solid #ffdede;color:#9b2c2c;padding:12px 14px;border-radius:12px;font-size:14px}
    .good{background:#f4fff6;border:1px solid #dff5e4;color:#1f7a3a;padding:12px 14px;border-radius:12px;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="halo"></div>
      <div class="hearts"></div>
      <h1>–ó–∞—è–≤–∫–∞ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞ <span class="badge">–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span></h1>
      <p class="lead">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –Ω–∞–±–æ—Ä –≤ –Ω—ë–º ‚ù§Ô∏è</p>

      <!-- –®–ê–ì 0 ‚Äî –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ -->
      <div id="cityStep">
        <div class="center" style="margin:6px 0 10px">
          <label for="cityChooser" style="font-weight:700">–ì–æ—Ä–æ–¥</label>
          <select id="cityChooser" style="min-width:260px">
            <!-- –∑–∞–ø–æ–ª–Ω–∏–º –∏–∑ JS -->
          </select>
          <button id="goBtn" class="btn primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
        <div id="cityNote" class="muted"></div>
        <div id="cityLock" class="notice hidden" style="margin-top:10px">
          –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞–±–æ—Ä –∑–∞—è–≤–æ–∫ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω.  
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥ ‚Äî –º—ã –æ—á–µ–Ω—å —Ü–µ–Ω–∏–º –≤–∞—à –æ—Ç–∫–ª–∏–∫ üôè
        </div>
        <div id="cityOk" class="good hidden" style="margin-top:10px">
          –ù–∞–±–æ—Ä –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –æ—Ç–∫—Ä—ã—Ç. –ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –Ω–∏–∂–µ.
        </div>
        <div class="divider"></div>
      </div>

      <!-- –°–∫—Ä—ã—Ç–∞—è —Ä–∞–º–∫–∞-—Ü–µ–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ -->
      <iframe name="hidden_iframe" style="display:none;"></iframe>

      <!-- –®–ê–ì 1 ‚Äî —Ñ–æ—Ä–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞) -->
      <form id="wishForm" class="hidden" action="https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec" method="POST" target="hidden_iframe">
        <!-- –°—é–¥–∞ —Å–æ–±–µ—Ä—ë–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ –±—Ä–∞—Ç—å—è–º/—Å—ë—Å—Ç—Ä–∞–º -->
        <input type="hidden" name="siblings_text" id="siblings_text" value=""/>

        <div class="grid grid-2">
          <div class="row">
            <label>–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è —Ä–µ–±—ë–Ω–∫–∞ <span class="required">*</span></label>
            <input type="text" name="child_name" required />
          </div>
          <div class="row">
            <label>–í–æ–∑—Ä–∞—Å—Ç (–ø–æ–ª–Ω—ã—Ö –ª–µ—Ç) <span class="required">*</span></label>
            <input type="number" name="child_age" min="0" step="0.1" required />
          </div>
        </div>

        <div class="grid grid-2">
          <div class="row">
            <label>–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏—é (–ª–µ—Ç) <span class="required">*</span></label>
            <input type="number" name="child_equivalent_age" min="0" step="0.1" required />
          </div>
          <div class="row">
            <label>–ü–∏—â–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è <span class="required">*</span></label>
            <select name="food_restrictions" id="food_select" required>
              <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ</option>
              <option>–ù–µ—Ç –ø–∏—â–µ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</option>
              <option>–ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≥–ª—é—Ç–µ–Ω</option>
              <option>–ù–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã</option>
              <option>–ê–ª–ª–µ—Ä–≥–∏–∏ (—É–∫–∞–∑–∞—Ç—å –Ω–∏–∂–µ)</option>
              <option>–î—Ä—É–≥–æ–µ (—É–∫–∞–∑–∞—Ç—å –Ω–∏–∂–µ)</option>
              <option>–ü–∞–ª–ª–∏–∞—Ç–∏–≤</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label>–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
          <textarea name="food_notes"></textarea>
        </div>

        <div class="divider"></div>

        <h3 style="margin:10px 0 6px">–î—Ä—É–≥–∏–µ –¥–µ—Ç–∏ –≤ —Å–µ–º—å–µ</h3>
        <div class="mini">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞.</div>

        <div class="siblings" id="siblings"></div>
        <div class="row">
          <button type="button" class="btn secondary" id="addSib">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</button>
        </div>

        <div class="divider"></div>

        <h3 style="margin:10px 0 6px">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∞–¥—Ä–µ—Å</h3>
        <div class="grid grid-3">
          <div class="row">
            <label>–ì–æ—Ä–æ–¥ <span class="required">*</span></label>
            <input type="text" name="city" id="cityField" required readonly />
          </div>
          <div class="row">
            <label>–†–∞–π–æ–Ω <span class="required">*</span></label>
            <input type="text" name="district" required />
          </div>
          <div class="row">
            <label>–£–ª–∏—Ü–∞ –∏ –¥–æ–º <span class="required">*</span></label>
            <input type="text" name="street" required />
          </div>
        </div>

        <div class="grid grid-3">
          <div class="row">
            <label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
            <input type="text" name="apartment" />
          </div>
          <div class="row">
            <label>–ò–º—è –º–∞–º—ã (–æ–ø–µ–∫—É–Ω–∞) <span class="required">*</span></label>
            <input type="text" name="parent_name" required />
          </div>
          <div class="row">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω <span class="required">*</span></label>
            <input type="tel" name="phone" id="phone" required />
            <div class="hint">–ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è: +7XXXXXXXXXX, 8XXXXXXXXXX, 9XXXXXXXXX (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏/—Å–∫–æ–±–∫–∞–º–∏/–¥–µ—Ñ–∏—Å–∞–º–∏ —Ç–æ–∂–µ –æ–∫)</div>
          </div>
        </div>

        <div class="consent">
          <input type="checkbox" id="consent" required />
          <label for="consent" class="footnote">
            –Ø —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ–ª–µ–π –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏. <span class="required">*</span>
          </label>
        </div>

        <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button type="submit" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
          <button type="reset" class="btn secondary" id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    // ==== –ö–æ–Ω—Ñ–∏–≥ ====
    const API_STATS = 'https://script.google.com/macros/s/AKfycbwzAkTH7Jg5Ov9-oduX9c18voH3pGrs0ZWoTqIZEVXVfEZxuuZ7dlBNAVtSP5RC_VW2fQ/exec?action=stats';
    const CITY_LIMIT = 500;
    const CITIES = [
      "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫","–¢–æ–º—Å–∫","–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫","–û–±—å","–ò—Å–∫–∏—Ç–∏–º","–ë–µ—Ä–¥—Å–∫","–ß–µ–ª—è–±–∏–Ω—Å–∫","–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥","–¢—é–º–µ–Ω—å",
      "–ù–æ–≤–æ–º–æ—Å–∫–æ–≤—Å–∫","–í–ª–∞–¥–∏–º–∏—Ä","–ü–∞—à–∏–Ω–æ","–ì–≤–∞—Ä–¥–µ–π—Å–∫–∏–π","–ö–∞–º–µ–Ω—å-–Ω–∞-–û–±–∏","–î–ù–†","–ì–∞—Ç—á–∏–Ω–∞","–ö—Ä–∞—Å–Ω–æ–æ–±—Å–∫",
      "–¢–æ–≥—É—á–∏–Ω","–°–æ–∫—É—Ä","–ö—É–π–±—ã—à–µ–≤","–ö–æ–ª—ã–≤–∞–Ω—å","–í–µ—Ä—Ö –¢—É–ª–∞","–°–∞–º–∞—Ä–∞","–ù–æ—Ä–∏–ª—å—Å–∫","–ß–µ—Ä–µ–ø–∞–Ω–æ–≤–æ","–í–æ—Ä–æ–Ω–æ–≤–æ",
      "–ö–æ–ª—å—Ü–æ–≤–æ","–ö–∞–∑–∞–Ω–∫–∞","–ö–∏–Ω–µ–ª—å (–ê–ª–µ–∫—Å–µ–µ–≤–∫–∞, –°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª.)","–ö—É–¥—Ä—è—à–æ–≤—Å–∫–∏–π","–ë–æ–ª—å—à–∞—è –ß–µ—Ä–Ω–∏–≥–æ–≤–∫–∞"
    ];

    // ==== –®–∞–≥ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ ====
    const cityStep = document.getElementById('cityStep');
    const cityChooser = document.getElementById('cityChooser');
    const cityNote = document.getElementById('cityNote');
    const cityLock = document.getElementById('cityLock');
    const cityOk = document.getElementById('cityOk');
    const goBtn = document.getElementById('goBtn');
    const form = document.getElementById('wishForm');
    const cityField = document.getElementById('cityField');

    // –∑–∞–ø–æ–ª–Ω–∏–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
    cityChooser.innerHTML = CITIES.map(c => `<option value="${c}">${c}</option>`).join('');
    cityChooser.value = "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫";

    let statsCache = null;
    async function ensureStats(){
      if (statsCache) return statsCache;
      try{
        const r = await fetch(API_STATS, {cache:'no-store'});
        statsCache = await r.json();
      }catch(_){
        statsCache = { byCity:{} };
      }
      return statsCache;
    }

    async function checkCity(){
      cityLock.classList.add('hidden');
      cityOk.classList.add('hidden');
      goBtn.disabled = true;
      cityNote.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞–±–æ—Ä–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ...';
      const data = await ensureStats();
      const city = cityChooser.value;
      const rec = data.byCity && data.byCity[city] ? data.byCity[city] : {addresses:0};
      const taken = Number(rec.addresses||0);
      if (taken >= CITY_LIMIT){
        cityNote.textContent = '';
        cityLock.classList.remove('hidden');
        goBtn.disabled = true;
      }else{
        cityNote.textContent = '';
        cityOk.classList.remove('hidden');
        goBtn.disabled = false;
      }
    }

    cityChooser.addEventListener('change', checkCity);
    checkCity();

    goBtn.addEventListener('click', ()=>{
      // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥
      form.classList.remove('hidden');
      cityField.value = cityChooser.value;
      cityField.readOnly = true;
      // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
      form.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // === –ë–ª–æ–∫ "–î—Ä—É–≥–∏–µ –¥–µ—Ç–∏" ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ===
    const statusEl = document.getElementById('status');
    const siblingsWrap = document.getElementById('siblings');
    const addBtn = document.getElementById('addSib');
    const sibField = document.getElementById('siblings_text');

    function sibTemplate(i){
      const el = document.createElement('div');
      el.className = 'sib';
      el.innerHTML = `
        <h4>–†–µ–±—ë–Ω–æ–∫ –≤ —Å–µ–º—å–µ #${i}</h4>
        <div class="grid grid-2">
          <div class="row">
            <label>–ò–º—è</label>
            <input type="text" data-sib="name" />
          </div>
          <div class="row">
            <label>–í–æ–∑—Ä–∞—Å—Ç</label>
            <input type="text" data-sib="age" />
          </div>
        </div>
        <div class="grid grid-2">
          <div class="row">
            <label>–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏—é (–ª–µ—Ç)</label>
            <input type="number" min="0" step="0.1" data-sib="equivalent" />
          </div>
          <div class="row">
            <label>–ü–∏—â–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</label>
            <select data-sib="food">
              <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ</option>
              <option>–ù–µ—Ç –ø–∏—â–µ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</option>
              <option>–ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≥–ª—é—Ç–µ–Ω</option>
              <option>–ù–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã</option>
              <option>–ê–ª–ª–µ—Ä–≥–∏–∏ (—É–∫–∞–∑–∞—Ç—å –Ω–∏–∂–µ)</option>
              <option>–î—Ä—É–≥–æ–µ (—É–∫–∞–∑–∞—Ç—å –Ω–∏–∂–µ)</option>
              <option>–ü–∞–ª–ª–∏–∞—Ç–∏–≤</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button type="button" class="btn secondary" data-action="remove">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      return el;
    }

    function renumberSiblings(){
      document.querySelectorAll('.sib h4').forEach((h,idx)=>h.textContent=`–†–µ–±—ë–Ω–æ–∫ –≤ —Å–µ–º—å–µ #${idx+1}`);
    }

    function serializeSiblingsToText(){
      const lines = [];
      document.querySelectorAll('.sib').forEach(box=>{
        const name = (box.querySelector('[data-sib="name"]').value||'').trim();
        const age  = (box.querySelector('[data-sib="age"]').value||'').trim();
        const eq   = (box.querySelector('[data-sib="equivalent"]').value||'').trim();
        const foodSel = box.querySelector('[data-sib="food"]');
        const food = foodSel ? (foodSel.value || '').trim() : '';

        if (name || age || eq || food){
          const parts = [];
          if (name) parts.push(name);
          if (age) parts.push(age);
          if (eq)  parts.push(`—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ${eq}`);
          if (food) parts.push(food);
          lines.push(parts.join(', '));
        }
      });
      sibField.value = lines.join('\n');
    }

    addBtn.addEventListener('click', ()=>{
      const i = document.querySelectorAll('.sib').length + 1;
      siblingsWrap.appendChild(sibTemplate(i));
    });

    siblingsWrap.addEventListener('click', (e)=>{
      if(e.target.matches('[data-action="remove"]')){
        e.target.closest('.sib').remove();
        renumberSiblings();
        serializeSiblingsToText();
      }
    });
    siblingsWrap.addEventListener('input', serializeSiblingsToText);
    siblingsWrap.addEventListener('change', serializeSiblingsToText);

    // === –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/–≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí +7XXXXXXXXXX ===
    function normalizePhone(raw){
      const digits = (raw.match(/\d/g) || []).join('');
      if (digits.length === 11 && digits[0] === '8') return '+7' + digits.slice(1);
      if (digits.length === 11 && digits[0] === '7') return '+7' + digits.slice(1);
      if (digits.length === 10 && digits[0] === '9') return '+7' + digits;
      const compact = raw.replace(/\s|\-|\(|\)/g,'');
      if (compact.startsWith('+7') && digits.length === 11 && digits[0] === '7') {
        return '+7' + digits.slice(1);
      }
      return null;
    }

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—ã–π iframe ===
    let submitted = false;
    const iframe = document.querySelector('iframe[name="hidden_iframe"]');
    iframe.addEventListener('load', ()=>{
      if (!submitted) return;
      statusEl.innerHTML = '<span class="ok">–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.</span>';
      form.reset();
      // –≤–µ—Ä–Ω—É—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –≤ –ø–æ–ª–µ
      cityField.value = cityChooser.value;
      siblingsWrap.innerHTML = '';
      sibField.value = '';
      submitted = false;
      window.scrollTo({top:0, behavior:'smooth'});
    });

    form.addEventListener('submit', (e)=>{
      // —Å–æ–±—Ä–∞—Ç—å –±—Ä–∞—Ç—å–µ–≤/—Å–µ—Å—Ç—ë—Ä
      serializeSiblingsToText();

      // –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
      const phoneInput = document.getElementById('phone');
      const norm = normalizePhone(phoneInput.value);
      if(!norm){
        e.preventDefault();
        statusEl.innerHTML = '<span class="err">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω. –ü—Ä–∏–º–µ—Ä: +7 913 913-33-33 –∏–ª–∏ 8 913 913 33 33 –∏–ª–∏ 9139133333.</span>';
        phoneInput.focus();
        return;
      }
      phoneInput.value = norm;

      // –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
      cityField.value = cityChooser.value;

      submitted = true;
      statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
    });

    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ä–æ–¥
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      setTimeout(()=>{ cityField.value = cityChooser.value; }, 0);
    });
  </script>
</body>
</html>
